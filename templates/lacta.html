<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <title>Gerador de Conte√∫do - Lacta</title>
        <!-- Estilos -->
        <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
        <!-- Flatpickr (Calend√°rio) -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    </head>
    <body>

    <!-- Cabe√ßalho / Topo -->
    <header class="header-bar">
        <div class="header-logo">
            <a href="{{ url_for('routes.login') }}">
                <img src="static/src/bump_small_logo-noBG.png" alt="bump">
            </a>
        </div>
        <nav class="header-menu">
            <ul>
                <li><a href="{{ url_for('routes.lacta') }}" class="active"><button id="generate-button">CRIAR CONTE√öDO</button></a></li>
                <!-- Ajuste a rota para a sua view de slogans avaliados, se quiser -->
                <li><a href="{{ url_for('routes.avaliados') }}"><button id="generate-button">AVALIADOS</button></a></li>
            </ul>
        </nav>
    </header>

    <!-- Se√ß√£o principal -->
    <main class="container">

        <!-- T√≠tulo principal / Subt√≠tulo -->
        <section class="intro">
            <h2>Criador de Conte√∫do</h2>
            <p>Comece a criar as mensagens certas para o momento certo</p>
            <ol>
                <li>No campo "Com quem esse conte√∫do vai falar?" coloque qual regi√£o quer alcan√ßar com o slogan</li>
                <li>Selecione no campo "Qual o per√≠odo de visualiza√ß√£o do conte√∫do?" a data que voc√™ quer usar como contexto para a cria√ß√£o dos slogans, isso vai influenciar os dados em tempo real</li>
                <li>Voc√™ consegue selecionar qual o ponto de venda que vai receber esse cont√©udo no campo "Qual o per√≠odo de visualiza√ß√£o do conte√∫do?"</li>
                <li>Escolha qual o momento para sua mensagem no campo "Qual o melhor momento para a sua mensagem?", aprofundando a cria√ß√£o do slogan</li>
                <li>Ap√≥s isso √© s√≥ clicar em "CRIAR CONTE√öDO" e voc√™ ter√° seus slogans prontos</li>
            </ol>
        </section>

        <!-- Formul√°rio principal -->
        <form class="campaign-form" action="{{ url_for('routes.lacta') }}" method="post">
            <div class="form-row">
                <!-- 1) Onde a oferta vai rodar? -->
                <div class="form-group">
                    <label for="localizacao">Com quem esse conte√∫do vai falar?</label>
                    <input 
                        type="text" 
                        id="localizacao" 
                        placeholder="Digite Estado, Cidade ou Bairro" 
                        autocomplete="off" 
                        required
                    >
                    <ul 
                        id="suggestions" 
                        style="display:none;"
                    >
                        <!-- Sugest√µes geradas dinamicamente -->
                    </ul>
                    <!-- Campos ocultos preenchidos dinamicamente -->
                    <input type="hidden" id="estado" name="estado">
                    <input type="hidden" id="cidade" name="cidade">
                    <input type="hidden" id="bairro" name="bairro">
                </div>

                <!-- 2) Com quem voc√™ quer falar? (loja) -->
                <div class="form-group">
                    <label for="loja">Quais pontos de venda v√£o receber esse conte√∫do?</label>
                    <select id="loja" name="loja" required>
                        <option value="" disabled selected>Selecione</option>
                        <option value="Store 1">Loja 1</option>
                        <option value="Store 2">Loja 2</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <!-- 3) Quando a oferta vai rodar? (intervalo de datas) -->
                <div class="form-group">
                    <label for="data_campanha">Qual o per√≠odo de visualiza√ß√£o do conte√∫do?</label>
                    <input 
                        type="text" 
                        id="data_campanha" 
                        class="datepicker" 
                        name="data_campanha" 
                        placeholder="Selecione o intervalo" 
                        required
                    >
                </div>

                <!-- 4) Que momento do dia recebe essa mensagem? -->
                <div class="form-group">
                    <label>Qual o melhor momento para a sua mensagem?</label>
                    <div class="time-ranges">
                        <label><input type="checkbox" name="time_range" value="early_morning"> Manh√£</label>
                        <label><input type="checkbox" name="time_range" value="afternoon"> Tarde</label>
                        <label><input type="checkbox" name="time_range" value="night"> Noite</label>
                        <label><input type="checkbox" name="time_range" value="late_at_night"> Madrugada</label>
                        <label><input type="checkbox" name="time_range" value="full_day"> Dia todo</label>
                        <label><input type="time" > Escolher outro hor√°rio</label>
                    </div>
                </div>
            </div>

            <!-- Bot√£o para gerar conte√∫do -->
            <div class="buttons-container">
                <button 
                    id="generate-button" 
                    type="submit"
                >
                    CRIAR CONTE√öDO
                </button>
            </div>
        </form>

        <label>Deixe seu conte√∫do mais relevante, conectando com dados em tempo real:</label>
        <!-- Se√ß√£o de dados em tempo real (caso queira manter) -->
        <div class="real-time-data">
            <label class="checkbox-container">
                üå§Ô∏è <strong>CLIMA LOCAL</strong><br>
                <input type="checkbox" class="data-checkbox" data-type="weather">
                <span class="checkmark"></span>
                <span class="data-text">{{ real_time_date.weather if real_time_date else "Carregando..." }}</span>
            </label>
            <label class="checkbox-container disabled">
                #Ô∏è‚É£ <strong>SOCIAL TRENDS</strong><br>
                <input type="checkbox" class="data-checkbox" data-type="trending">
                <span class="checkmark"></span>
                <span class="data-text">{{ real_time_date.trending if real_time_date else "Carregando..." }}</span>
            </label>
            <label class="checkbox-container disabled">
                üìÖ <strong>EVENTOS LOCAIS</strong><br>
                <input type="checkbox" class="data-checkbox" data-type="local-events">
                <span class="checkmark"></span>
                <span class="data-text">{{ real_time_date.local_events if real_time_date else "Carregando..." }}</span>
            </label>
            <label class="checkbox-container disabled">
                üé¨ <strong>AGENDA CULTURAL</strong><br>
                <input type="checkbox" class="data-checkbox" data-type="pop-culture">
                <span class="checkmark"></span>
                <span class="data-text">{{ real_time_date.pop_culture if real_time_date else "Carregando..." }}</span>
            </label>
        </div>


        <!-- Bot√µes adicionais (Avaliados e Refazer) -->
        <div class="buttons-container">
            <form action="{{ url_for('routes.avaliados') }}" method="post">
                <button id="slogans-button" type="submit">
                    VER OP√á√ïES AVALIADAS
                </button>
            </form>
            <form id="refazer-form" action="{{ url_for('routes.lacta') }}" method="POST" style="display:inline-block;">
                <!-- Esses inputs s√£o apenas placeholders caso precise re-enviar -->
                <input type="hidden" name="time_range" value="">
                <input type="hidden" name="data_campanha" value="">
                <input type="hidden" name="estado" value="">
                <input type="hidden" name="cidade" value="">
                <input type="hidden" name="bairro" value="">
                <button id="refazer-button" type="submit">
                    CRIAR NOVAS OP√á√ïES
                </button>
            </form>
        </div>

        <!-- Se√ß√£o de op√ß√µes criativas de slogans -->
        <section class="slogan-section">
            <h2>Op√ß√µes Criativas</h2>
            <div class="slogan-options">
                {% if slogans_imagens %}
                    {% for slogan, imagem in slogans_imagens %}
                        <div class="slogan-box">
                            <img src="{{ imagem }}" alt="Slogan" class="slogan-image">

                            <img src="static/brands/lacta/bottom/bottom_lct.jpeg" alt="Lacta_baseplate" class="slogan-image">
                            
                            
                            <!-- Bot√µes de avalia√ß√£o -->
                            <div class="slogan-controls">
                                <button class="like-button" data-imagem="{{ imagem }}" data-avaliacao="like">üëç</button>
                                <button class="dislike-button" data-imagem="{{ imagem }}" data-avaliacao="dislike">üëé</button>
                            </div>
                            <button id="publish-button" data-imagem="{{ imagem }}" data-slogan="{{ slogan }}" type="button">
                                PUBLICAR
                            </button>
                            <button class="edit-button" data-imagem="{{ imagem }}" data-slogan="{{ slogan }}">
                                EDITAR
                            </button>
                            

                            <!-- Modal de Edi√ß√£o -->
                            <div class="modal edit-modal" style="display:none;">
                                <div class="modal-content">
                                    <span class="close" style="font-size: 35px; color: red">&times;</span>
                                    <h3>EDITAR SLOGAN</h3>
                                    <input type="text" class="new-slogan-input" placeholder="Digite o novo slogan">
                                    <button class="save-slogan-btn">SALVAR</button>
                                </div>
                            </div>
                            
                        </div>
                    {% endfor %}
                {% else %}
                    <p>Nenhum conte√∫do gerado ainda. Preencha o formul√°rio acima e clique em "CRIAR CONTE√öDO".</p>
                {% endif %}
            </div>
        </section>

    </main>

    <!-- Rodap√© -->
    <footer class="footer-bar">
        <p>¬© Lacta¬Æ. All rights reserved - 2025.</p>
    </footer>

    <!-- 
        SCRIPTS DO C√ìDIGO 
    -->

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- PERSISTIR OQUE FOI COLOCADO NO FORMUL√ÄRIO DE CRIA√á√ÇO -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const campaignForm = document.querySelector('.campaign-form');
            
            campaignForm.addEventListener('submit', function() {
                const estado = document.getElementById('estado').value;
                const cidade = document.getElementById('cidade').value;
                const bairro = document.getElementById('bairro').value;
                const dataCampanha = document.getElementById('data_campanha').value;
                const timeRanges = Array.from(document.querySelectorAll('input[name="time_range"]:checked'))
                    .map(el => el.value)
                    .join(', ');
        
                const formData = {
                    estado,
                    cidade,
                    bairro,
                    dataCampanha,
                    timeRanges
                };
        
                // Salva no Local Storage
                localStorage.setItem('formData', JSON.stringify(formData));
            });
        });
        window.addEventListener('beforeunload', function() {
            localStorage.removeItem('formData');
        });
    </script>
        
    <!-- FUNCIONAMENTO BOT√ÉO REFAZER SLOGANS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const refazerForm = document.getElementById('refazer-form');
            const refazerButton = document.getElementById('refazer-button');
        
            refazerButton.addEventListener('click', function(event) {
                event.preventDefault();
        
                // Recupera do Local Storage
                const formData = JSON.parse(localStorage.getItem('formData'));
                if (!formData) {
                    alert('Nenhuma informa√ß√£o salva. Por favor, preencha o formul√°rio.');
                    return;
                }
        
                // Preenche os inputs escondidos do refazer-form
                refazerForm.querySelector('input[name="estado"]').value = formData.estado;
                refazerForm.querySelector('input[name="cidade"]').value = formData.cidade;
                refazerForm.querySelector('input[name="bairro"]').value = formData.bairro;
                refazerForm.querySelector('input[name="data_campanha"]').value = formData.dataCampanha;
                refazerForm.querySelector('input[name="time_range"]').value = formData.timeRanges;
        
                // Envia o formul√°rio
                refazerForm.submit();
            });
        });
    </script>    
    
    <!-- AUTO COMPLEMENTO DA PESQUISA DE CIDADE -->
    <script>
        // SUGEST√ïES DE LOCALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('localizacao');
            const suggestions = document.getElementById('suggestions');
            const estadoInput = document.getElementById('estado');
            const cidadeInput = document.getElementById('cidade');
            const bairroInput = document.getElementById('bairro');
    
            // Carregar os dados do JSON
            fetch('/static/data/estados_cidades_bairros.json')
                .then(response => response.json())
                .then(data => {
                    // Atualizar sugest√µes conforme o usu√°rio digita
                    input.addEventListener('input', () => {
                        const query = input.value.toLowerCase();
                        suggestions.innerHTML = '';
    
                        if (query.length < 2) {
                            suggestions.style.display = 'none';
                            return;
                        }
    
                        // Filtrar os dados para encontrar correspond√™ncias
                        const matches = [];
                        for (const [estado, cidades] of Object.entries(data)) {
                            for (const [cidade, bairros] of Object.entries(cidades)) {
                                if (estado.toLowerCase().includes(query) || cidade.toLowerCase().includes(query)) {
                                    matches.push(`${estado} - ${cidade}`);
                                }
                                bairros.forEach(bairro => {
                                    if (bairro.toLowerCase().includes(query)) {
                                        matches.push(`${estado} - ${cidade} - ${bairro}`);
                                    }
                                });
                            }
                        }
    
                        // Exibir as sugest√µes
                        if (matches.length > 0) {
                            matches.forEach(match => {
                                const li = document.createElement('li');
                                li.textContent = match;
                                li.addEventListener('click', () => {
                                    input.value = match;
                                    suggestions.style.display = 'none';
    
                                    // Preencher campos hidden
                                    const parts = match.split(' - ');
                                    estadoInput.value = parts[0] || '';
                                    cidadeInput.value = parts[1] || '';
                                    bairroInput.value = parts[2] || '';
                                });
                                suggestions.appendChild(li);
                            });
                            suggestions.style.display = 'block';
                        } else {
                            suggestions.style.display = 'none';
                        }
                    });
    
                    // Esconder as sugest√µes ao clicar fora
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.form-group')) {
                            suggestions.style.display = 'none';
                        }
                    });
                })
                .catch(error => console.error('Erro ao carregar os dados:', error));
        });
    </script>

    <!-- CHAMADA DE ENDPOINT PARA ATUALIZAR O SPAN DO CLIMA -->
    <script>
        async function updateWeather() {
        const estado = document.getElementById('estado').value;
        const cidade = document.getElementById('cidade').value;
        const bairro = document.getElementById('bairro').value;
        const dataCampanha = document.getElementById('data_campanha').value;
        if (!estado || !cidade || !dataCampanha) return;  // s√≥ executa se tiver tudo
    
        try {
            const params = new URLSearchParams({
            estado, cidade, bairro,
            data_campanha: dataCampanha
            });
            const res = await fetch(`/real_time_data?${params.toString()}`);
            const json = await res.json();
            // Seleciona o label de clima e atualiza o texto
            const label = document.querySelector('.checkbox-container input[data-type="weather"]')
                                .closest('.checkbox-container');
            label.querySelector('.data-text').innerText = json.weather;
        } catch (err) {
            console.error('Erro ao atualizar clima:', err);
        }
        }
    
        document.addEventListener('DOMContentLoaded', () => {
        // 1) Chamar ao selecionar sugest√£o de localiza√ß√£o
        document.getElementById('suggestions').addEventListener('click', () => {
            // Delay para garantir que os campos hidden j√° foram preenchidos
            setTimeout(updateWeather, 100);
        });

        });
    </script>
  
    <!-- CONFIGURA√á√ÉO PARA O CALEND√ÅRIO E ATIVA√á√ÉO DO ENDPOINT PARA ATUALIZAR O SPAN DE CLIMA -->
    <script>
        // DATEPICKER (FLATPICKR)
        document.addEventListener("DOMContentLoaded", function() {
            flatpickr("#data_campanha", {
                mode: "range",
                dateFormat: "d/m/Y",
                minDate: "today",
                locale: {
                    firstDayOfWeek: 0,
                    weekdays: {
                        shorthand: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"],
                        longhand: ["Domingo", "Segunda-feira", "Ter√ßa-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "S√°bado"]
                    },
                    months: {
                        shorthand: ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"],
                        longhand: ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]
                    }
                },
                onChange: function(selectedDates, dateStr, instance) {
                    updateWeather();
                    console.log("Datas selecionadas:", dateStr);
                }
            });
        });
    </script>

    <!-- FUNCIONAMENTO DO BOT√ÉO DE LIKE E DISLIKE -->
    <script>
        // BOT√ïES LIKE/DISLIKE
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.like-button, .dislike-button').forEach(button => {
                button.addEventListener('click', function() {
                    const imagem = this.getAttribute('data-imagem');
                    const avaliacao = this.getAttribute('data-avaliacao');
                    
                    fetch('/avaliar_slogan', {
                        method: 'POST',
                        body: new URLSearchParams({
                            'slogan_image': imagem,
                            'avaliacao': avaliacao
                        }),
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(data.message)
                            console.log('Likes:', data.likes);
                            console.log('Dislikes:', data.dislikes);
                        } else {
                            alert("Erro ao avaliar slogan");
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao avaliar slogan:', error);
                    });
                });
            });
        });
    </script>

    <!-- PAUSAR O V√çDEO AO GERAR ELE -->
    <script>
        
        var videos = document.querySelectorAll('#slogan-video-player');

        var startAtSecond = 14;

        videos.forEach(function(video) {
            video.onloadedmetadata = function() {
                video.currentTime = startAtSecond;
                video.pause();
                video.controls = false;
            };
        });


    </script>

    <!-- FUNCIONAMENTO DO MODAL DE EDITAR -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Para cada bot√£o "EDITAR", ao ser clicado, localize o modal relativo √† mesma .slogan-box
        document.querySelectorAll('.edit-button').forEach(button => {
            button.addEventListener('click', function() {
                // Encontra o container pai (a div .slogan-box)
                const sloganBox = this.closest('.slogan-box');
                // Seleciona o modal dentro desse container
                const editModal = sloganBox.querySelector('.edit-modal');
                // Preenche o input com o slogan atual, se estiver armazenado no bot√£o
                const newSloganInput = sloganBox.querySelector('.new-slogan-input');
                newSloganInput.value = this.getAttribute('data-slogan');
                // Exibe o modal
                editModal.style.display = 'block';
                
                // Fecha o modal ao clicar no elemento com a classe "close"
                sloganBox.querySelector('.close').addEventListener('click', () => {
                    editModal.style.display = 'none';
                });

                // Ao clicar no bot√£o "Salvar" dentro do modal, envie a atualiza√ß√£o
                sloganBox.querySelector('.save-slogan-btn').addEventListener('click', () => {
                    const novoSlogan = newSloganInput.value;
                    // Obtenha o caminho atual do v√≠deo (por exemplo, do <source> dentro do v√≠deo deste container)
                    const currentVideoElement = sloganBox.querySelector('video');
                    const oldVideoPath = currentVideoElement.querySelector('source').getAttribute('src');

                    fetch('/editar_slogan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            video_path: oldVideoPath,
                            novo_slogan: novoSlogan
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if(data.status === 'success') {
                            const novoVideoPath = data.novo_video_path;
                            // Atualiza o src do v√≠deo
                            const sourceElement = currentVideoElement.querySelector('source');
                            sourceElement.setAttribute('src', novoVideoPath);
                            currentVideoElement.load();

                            // Atualiza os atributos data-imagem e data-slogan dos bot√µes do container
                            sloganBox.querySelectorAll('.like-button, .dislike-button, #publish-button, .edit-button').forEach(btn => {
                                btn.dataset.imagem = novoVideoPath;
                            });
                            // Atualiza o bot√£o "EDITAR" com o novo slogan
                            this.setAttribute('data-slogan', novoSlogan);
                            alert('V√≠deo atualizado com sucesso!');
                        } else {
                            alert('Erro ao atualizar slogan: ' + data.message);
                        }
                        editModal.style.display = 'none';
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        editModal.style.display = 'none';
                    });
                });
            });
        });
    });

    </script>

    <!-- SCRIPT PUBLICAR NA TELA DE TESTE -->
    <script>
        // PUBLICA√á√ÉO DE CONTE√öDO
        document.querySelectorAll('#publish-button').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const slogan = this.getAttribute('data-slogan');
                
                fetch('/publish-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        slogan: slogan,
                        brand: 'Lacta'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if(data.status === 'success') {
                        alert('Conte√∫do publicado com sucesso!');
                    } else {
                        alert('Erro na publica√ß√£o: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro na comunica√ß√£o com o servidor');
                });
            });
        });
    </script>

</body>
</html>
